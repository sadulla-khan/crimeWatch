<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Map Picker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Esri Leaflet Geocoder CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.css" />
    <script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.js"></script>

    <style>
        html, body, #map {
          height: 100%;
          margin: 0;
          padding: 0;
        }
        .geocoder-control {
          position: absolute;
          top: 10px;
          left: 10px;
          z-index: 1000;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    var map = L.map('map').setView([23.8103, 90.4125], 13); // Default to Dhaka

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    // Add Esri Geosearch control
    var searchControl = L.esri.Geocoding.geosearch({
      position: 'topleft',
      placeholder: 'Search for places...',
      useMapBounds: false
    }).addTo(map);

    var results = L.layerGroup().addTo(map);

    searchControl.on('results', function(data) {
      results.clearLayers();
      if (marker) map.removeLayer(marker);

      if (data.results.length > 0) {
        var latlng = data.results[0].latlng;
        marker = L.marker(latlng).addTo(map);

        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=json`)
          .then(response => response.json())
          .then(data => {
            let address = data.display_name;
            Android.sendLocation(latlng.lat.toString(), latlng.lng.toString(), address);
          });
      }
    });

    // Manual map click handler
    map.on('click', function(e) {
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng).addTo(map);

      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e.latlng.lat}&lon=${e.latlng.lng}&format=json`)
        .then(response => response.json())
        .then(data => {
          let address = data.display_name;
          Android.sendLocation(e.latlng.lat.toString(), e.latlng.lng.toString(), address);
        });
    });
</script>
</body>
</html>
